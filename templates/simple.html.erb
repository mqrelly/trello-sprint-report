<%

$barchart_max_height = 240;

def bar_height_in_px(card_count)
  relative_height = card_count.to_f / all_card_ids.count
  (relative_height * $barchart_max_height).to_i
end

%>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Sprint Report <%= start_date %> - <%= end_date %></title>
  <style>
    .report {
      margin: 50px;
      font-family: "Tahoma", sans-serif;
      font-size: 14pt;
      color: #333;
    }

    .label-symbol {
      display: inline-block;
      border: solid 15px;
      border-radius: 3px;
    }

    .label-symbol.tag {
      border-left-width: 17px;
      border-right-width: 17px;
      border-top-width: 4px;
      border-bottom-width: 4px;
    }

    .label-symbol.green {
      border-color: #61BD4F;
    }

    .label-symbol.yellow {
      border-color: #F2D600;
    }

    .label-symbol.orange {
      border-color: #FFAB4A;
    }

    .label-symbol.red {
      border-color: #EB5A46;
    }

    .label-symbol.purple {
      border-color: #C377E0;
    }

    .label-symbol.blue {
      border-color: #0079BF;
    }

    .label-symbol.sky {
      border-color: #00C2E0;
    }

    .label-symbol.pink {
      border-color: #FF80CE;
    }

    .label-symbol.black {
      border-color: #4d4d4d;
    }

    .list {
      list-style: none;
      padding-left: inherit;
    }

    .labels.list .label {
      margin: 5px 0;
    }

    .labels.list > li > * {
      display: inline-block;
      vertical-align: middle;
    }

    .label .name {
      font-size: 16px;
    }

    .label .statistics {
      font-size: 13pt;
      font-style: italic;
      color: gray;
    }

    .cards.list {
      display: inline-block;
      margin: 0;
    }

    .card {
      display: block;
      margin: 20px 0;
    }

    .card .name,
    .card .name * {
      color: inherit;
      text-decoration: none;
    }

    .card .labels {
      font-size: 0;
      margin-top: 5px;
    }

    .card .labels .label-symbol {
      margin-right: 5px;
    }

    .badge {
      display: inline-block;
      float: right;
      padding: 4px 7;
      border-radius: 3px;
      color: white;
      font-size: 8pt;
      font-weight: bolder;
      text-transform: uppercase;
    }

    .abandoned .badge {
      background-color: #fca5a5;
    }

    .in-progress .badge {
      background-color: #ffd276;
    }

    .done .badge {
      background-color: #7ec07e;
    }

    .card.abandoned .name {
      font-style: italic;
      text-decoration: line-through;
      color: gray;
    }

    .barchart {
      display: grid;
      max-width: <%= (lists.count + 2) * 200 %>px;
    }

    .barchart .column {
      position: relative;
      grid-row-start: 1;
      min-width: 100px;

      display: flex;
      flex-flow: column-reverse nowrap;
    }

    .barchart .column .bar {
      width: 50px;
      margin: 10px auto;
      background-color: silver;
    }

    .barchart .column .label {
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      padding: 0 2px;
    }

    .barchart .column .amount {
      position: relative;
      height: 36px;
      width: 36px;
      text-align: center;
      line-height: 36px;
      vertical-align: middle;
      border: solid 2px gray;
      border-radius: 19px;
      margin: 0 auto;
    }
  </style>
</head>

<body class="report">

  <h1>Sprint Report</h1>
  <h2><%= start_date %> - <%= end_date %> (<%= sprint_days %> days)</h2>


  <h3>Progress</h3>

  <div class="barchart">
    <div class="column">
      <div class="label">Incoming</div>
      <div class="bar" style="height: <%= bar_height_in_px(incoming_card_ids.count) %>px;"></div>
      <div class="amount"><%= incoming_card_ids.count %></div>
    </div>

  <% lists.each_with_index do |list, idx| %>
    <div class="column">
      <div class="label"><%= list["name"] %></div>
      <div class="bar" style="height: <%= bar_height_in_px(list["cards"].count) %>px;"></div>
      <div class="amount"><%= list["cards"].count %></div>
    </div>
  <% end %>

    <div class="column">
      <div class="label">Abandoned</div>
      <div class="bar" style="height: <%= bar_height_in_px(abandoned_card_ids.count) %>px;"></div>
      <div class="amount"><%= abandoned_card_ids.count %></div>
    </div>
  </div>


  <h3>Labels</h3>

  <ul class="labels list">
    <% all_label_ids.map{|id| label(id)}.each do |label| %>
    <li class="label">
      <span class="label-symbol <%= label["color"] %>"></span>
      <span class="name"><%= label["name"] %></span>
      <span class="statistics">(<%= cards_with_label(label["id"]).length %> cards)</span>
    </li>
    <% end %>
  </ul>


  <h3>Cards</h3>
  <ul class="cards list">
    <% all_card_ids.map{|id| card(id)}.each do |card| %>
    <li class="card <%= card["state"] %>">
      <div class="badge"><%= if card["state"] == "abandoned" then "abandoned" else card["list-name"] end %></div>
      <div class="name"><a href="<%= card["shortUrl"] %>"><%= card["name"] %></a></span>
      <div class="labels">
        <% card["labels"].each do |label| %>
        <span class="label-symbol tag <%= label["color"] %>"></span>
        <% end %>
      </div>
    </li>
    <% end %>
  </ul>

</body>
</html>
